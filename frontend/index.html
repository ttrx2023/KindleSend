<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Kindle Pro</title>
    <style>
        :root {
            --primary: #3b82f6; --bg-color: #f8fafc; --card-bg: #ffffff;
            --text-main: #1e293b; --text-sub: #64748b; --border: #e2e8f0; --success: #10b981;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; font-family: "Segoe UI", system-ui, sans-serif;
            background: var(--bg-color); color: var(--text-main);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--card-bg); padding: 16px 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            gap: 12px; z-index: 10; flex-shrink: 0;
        }
        .header-top, .filter-bar { display: flex; gap: 10px; align-items: center; }
        .filter-chip {
            padding: 5px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;
            cursor: pointer; background: #f1f5f9; color: var(--text-sub); border: 1px solid transparent;
        }
        .filter-chip.active { background: #eff6ff; color: var(--primary); border-color: #bfdbfe; }
        
        .search-wrapper { flex: 1; position: relative; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }
        input.search-input {
            width: 100%; padding: 12px 12px 12px 38px; border: 1px solid var(--border);
            border-radius: 8px; background: #f8fafc; outline: none; transition: 0.2s;
        }
        input.search-input:focus { background: #fff; border-color: var(--primary); }
        
        button {
            border: none; border-radius: 8px; padding: 10px 18px; font-weight: 600; font-size: 13px;
            cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-sub); }
        .btn-outline:hover { background: #f1f5f9; color: var(--text-main); }
        .btn-icon { padding: 10px; font-size: 16px; }

        /* Content List - åŠ é«˜è¡Œé«˜ */
        .content { flex: 1; padding: 20px 24px; overflow-y: auto; min-height: 0; }
        .file-card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        thead th {
            text-align: left; padding: 16px 20px; background: #f8fafc;
            border-bottom: 1px solid var(--border); color: var(--text-sub);
            position: sticky; top: 0; z-index: 5;
        }
        /* åˆ—è¡¨è¡ŒåŠ é«˜ä¼˜åŒ– */
        tbody td { padding: 18px 20px; color: var(--text-main); vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        tbody tr:hover { background: #f8fafc; cursor: pointer; }
        tbody tr.selected { background: #eff6ff; }
        .type-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; color: white; background: #94a3b8; margin-right: 10px; }
        .type-EPUB { background: #f59e0b; } .type-PDF { background: #ef4444; } .type-MOBI { background: #3b82f6; } .type-AZW3 { background: #10b981; }

        /* Footer */
        .footer { background: var(--card-bg); padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .btn-send { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px 30px; font-size: 15px; }
        .btn-send:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* Modals - åŠ å®½åŠ å¤§ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.show { display: flex; }
        /* æ¨¡æ€æ¡†å®½åº¦å¢åŠ åˆ° 800px */
        .modal-box {
            background: white; width: 800px; padding: 30px; border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            max-height: 95vh; display: flex; flex-direction: column;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 700; color: #0f172a; }
        .close-btn { cursor: pointer; font-size: 24px; color: #94a3b8; line-height: 1; }
        
        /* å·¦å³åˆ†æ å¸ƒå±€ (é’ˆå¯¹è®¾ç½®) */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }

        .form-group { margin-bottom: 8px; }
        .form-label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #475569; }
        .form-input { 
            width: 100%; padding: 12px; border: 1px solid var(--border); 
            border-radius: 8px; font-size: 14px; outline: none; background: #fff;
        }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        
        .saved-hint {
            margin-top: 4px; font-size: 12px; color: #10b981; 
            background: #f0fdf4; padding: 6px 10px; border-radius: 6px; 
            border: 1px solid #bbf7d0; display: flex; align-items: center; gap: 6px;
        }
        .saved-hint::before { content: 'âœ” å·²ä¿å­˜'; font-weight: bold; }
        .saved-hint.empty::before { content: 'âš ï¸ æœªè®¾ç½®'; }
        .saved-hint.empty { color: #b45309; background: #fffbeb; border-color: #fde68a; }

        /* å¸®åŠ©é¡µé¢æ ·å¼ */
        .help-content { overflow-y: auto; padding-right: 10px; }
        .help-card { background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .help-head { font-weight: 700; color: #334155; margin-bottom: 8px; font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .help-list { margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.6; color: #475569; }
        .help-list li { margin-bottom: 4px; }

        /* Log Toast */
        .log-overlay {
            position: fixed; bottom: 90px; right: 30px; width: 400px; max-height: 300px;
            background: rgba(15, 23, 42, 0.95); color: #fff; padding: 20px; border-radius: 12px;
            font-size: 13px; line-height: 1.6; overflow-y: auto; display: none; z-index: 200;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="search-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="query" class="search-input" placeholder="è¾“å…¥ä¹¦å (è‡ªåŠ¨è°ƒç”¨ fuckfbi.ru)...">
            </div>
            <button class="btn-primary" onclick="searchBook()">æœç´¢</button>
            <button class="btn-outline" onclick="testConn()">è¿é€šæµ‹è¯•</button>
            <button class="btn-outline btn-icon" onclick="openSettings()">âš™ï¸ è®¾ç½®</button>
            <button class="btn-outline btn-icon" onclick="openHelp()">â“ å¸®åŠ©</button>
        </div>
        <div class="filter-bar">
            <div class="filter-chip active" onclick="applyFilter('ALL', this)">å…¨éƒ¨</div>
            <div class="filter-chip" onclick="applyFilter('EPUB', this)">EPUB</div>
            <div class="filter-chip" onclick="applyFilter('PDF', this)">PDF</div>
            <div class="filter-chip" onclick="applyFilter('MOBI', this)">MOBI</div>
            <div class="filter-chip" onclick="applyFilter('AZW3', this)">AZW3</div>
        </div>
    </div>

    <div class="content">
        <div class="file-card">
            <table>
                <thead>
                    <tr><th style="width:40px;text-align:center"><input type="checkbox" id="selectAllCb" onchange="toggleAll(this)"></th><th>æ–‡ä»¶å</th><th style="width:100px">å¤§å°</th><th style="width:160px">ä¿®æ”¹æ—¶é—´</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
            <div id="empty-state" style="padding:60px;text-align:center;display:none;color:#64748b">
                <div style="font-size:40px;margin-bottom:10px">ğŸ“‚</div>
                <p>è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œè¯·å…ˆå»â€œè®¾ç½®â€æ£€æŸ¥ä¸‹è½½è·¯å¾„</p>
                <button class="btn-outline" onclick="loadFiles()" style="margin:15px auto">åˆ·æ–°åˆ—è¡¨</button>
            </div>
        </div>
    </div>
    <div id="log-overlay" class="log-overlay"></div>
    <div class="footer">
        <div class="status-bar">
            <button class="btn-outline" onclick="loadFiles()">ğŸ”„ åˆ·æ–°</button>
            <span id="status-text" style="margin-left:15px;font-size:14px;color:#64748b">å°±ç»ª</span>
        </div>
        <button class="btn-send" id="sendBtn" onclick="sendFiles()" disabled>ğŸš€ å‘é€é€‰ä¸­ä¹¦ç± (0)</button>
    </div>

    <div id="modal-settings" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><div class="modal-title">âš™ï¸ è½¯ä»¶é…ç½®</div><div class="close-btn" onclick="closeModal('modal-settings')">&times;</div></div>
            
            <div class="settings-grid">
                <div class="form-group">
                    <label class="form-label">å‘ä»¶äºº QQ é‚®ç®±</label>
                    <input type="text" id="cfg-sender" class="form-input" placeholder="ä¾‹å¦‚: 123@qq.com">
                    <div id="hint-sender" class="saved-hint empty">æœªé…ç½®</div>
                </div>
                <div class="form-group">
                    <label class="form-label">QQ é‚®ç®±æˆæƒç  (éå¯†ç )</label>
                    <input type="password" id="cfg-pass" class="form-input" placeholder="ä¾‹å¦‚: byqe...">
                    <div id="hint-pass" class="saved-hint empty">æœªé…ç½®</div>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Kindle æ¥æ”¶é‚®ç®±</label>
                    <input type="text" id="cfg-kindle" class="form-input" placeholder="ä¾‹å¦‚: name@kindle.com">
                    <div id="hint-kindle" class="saved-hint empty">æœªé…ç½®</div>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">æœ¬åœ°ä¹¦ç±ä¸‹è½½è·¯å¾„</label>
                    <input type="text" id="cfg-path" class="form-input" placeholder="ä¾‹å¦‚ D:\Downloads">
                    <div id="hint-path" class="saved-hint empty">æœªé…ç½®</div>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">æœç´¢ç½‘å€æ¨¡æ¿</label>
                    <input type="text" id="cfg-url" class="form-input">
                    <div id="hint-url" class="saved-hint empty">æœªé…ç½®</div>
                </div>
            </div>

            <div style="margin-top:auto; text-align:right; padding-top:20px;">
                <button class="btn-primary" onclick="saveSettings()" style="display:inline-flex; padding:12px 30px;">ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</button>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><div class="modal-title">ğŸ“– ä½¿ç”¨æŒ‡å—ä¸æ³¨æ„äº‹é¡¹</div><div class="close-btn" onclick="closeModal('modal-help')">&times;</div></div>
            <div class="help-content">
                <div class="help-card">
                    <div class="help-head">ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½</div>
                    <ul class="help-list">
                        <li><b>è‡ªåŠ¨æ¸…æ´—</b>ï¼šå‘é€æ—¶è‡ªåŠ¨åˆ é™¤æ–‡ä»¶åä¸­çš„ "(Z-Library)" ç­‰å¹¿å‘Šåç¼€ã€‚</li>
                        <li><b>é˜²ä¹±ç </b>ï¼šå†…ç½®ç¼–ç è½¬æ¢ï¼Œè§£å†³ Kindle æ”¶åˆ°ä¸­æ–‡ä¹¦åä¹±ç çš„é—®é¢˜ã€‚</li>
                        <li><b>ä¸€é”®ä¼ è¾“</b>ï¼šæ”¯æŒæ‰¹é‡é€‰æ‹©ï¼Œä¸€é”®é€šè¿‡é‚®ä»¶æ¨é€åˆ° Kindleã€‚</li>
                    </ul>
                </div>
                <div class="help-card">
                    <div class="help-head">âš™ï¸ é…ç½®ä¸‰æ­¥èµ° (é¦–æ¬¡å¿…çœ‹)</div>
                    <ul class="help-list">
                        <li>1. <b>QQ é‚®ç®±</b>ï¼šå¼€å¯ POP3/SMTP æœåŠ¡ï¼Œè·å– 16 ä½æˆæƒç  (è®¾ç½®->è´¦æˆ·)ã€‚</li>
                        <li>2. <b>äºšé©¬é€Š</b>ï¼šå°†ä½ çš„ QQ é‚®ç®±åŠ å…¥â€œå·²è®¤å¯çš„å‘ä»¶äººåˆ—è¡¨â€ (ä¸ªäººæ–‡æ¡£è®¾ç½®)ã€‚</li>
                        <li>3. <b>æœ¬è½¯ä»¶</b>ï¼šåœ¨è®¾ç½®ä¸­å¡«å…¥ä»¥ä¸Šä¿¡æ¯ï¼Œå¹¶æŒ‡å®šä¸‹è½½è·¯å¾„ã€‚</li>
                    </ul>
                </div>
                <div class="help-card" style="margin-bottom:0; background:#fffbeb; border-color:#fde68a;">
                    <div class="help-head" style="color:#b45309;">âš ï¸ å¸¸è§é—®é¢˜</div>
                    <ul class="help-list" style="color:#b45309;">
                        <li>â€¢ è‹¥æç¤º "Authentication failed"ï¼Œè¯·æ£€æŸ¥æˆæƒç æ˜¯å¦è¿‡æœŸæˆ–å¡«é”™ã€‚</li>
                        <li>â€¢ è‹¥ Kindle æ”¶ä¸åˆ°ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å·²åœ¨äºšé©¬é€Šåå°æ·»åŠ ç™½åå•ã€‚</li>
                        <li>â€¢ é…ç½®æ–‡ä»¶ç°åœ¨ä¿å­˜åœ¨ç³»ç»Ÿ AppData ç›®å½•ï¼Œå‡çº§è½¯ä»¶é…ç½®ä¸ä¸¢å¤±ã€‚</li>
                    </ul>
                </div>
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-primary" onclick="closeModal('modal-help')">æˆ‘å·²äº†è§£</button>
            </div>
        </div>
    </div>

    <script>
        let allBooks = [];
        let currentFilter = 'ALL';
        let globalConfig = { senderEmail:"", senderPass:"", targetKindle:"", downloadPath:"D:\\Downloads", searchUrl:"https://fuckfbi.ru/s/?q=%s" };

        window.onload = function() {
            window.go.main.App.GetSettings().then(([config, isFirstRun]) => {
                if(config.senderEmail) globalConfig = config;
                updateSettingsUI(globalConfig);
                if(isFirstRun) { openSettings(); } else { loadFiles(); }
            });
        };

        function updateSettingsUI(cfg) {
            document.getElementById('cfg-sender').value = cfg.senderEmail || "";
            document.getElementById('cfg-pass').value = cfg.senderPass || "";
            document.getElementById('cfg-kindle').value = cfg.targetKindle || "";
            document.getElementById('cfg-path').value = cfg.downloadPath || "D:\\Downloads";
            document.getElementById('cfg-url').value = cfg.searchUrl || "https://fuckfbi.ru/s/?q=%s";

            updateHint('hint-sender', cfg.senderEmail);
            updateHint('hint-pass', cfg.senderPass ? "******" : "");
            updateHint('hint-kindle', cfg.targetKindle);
            updateHint('hint-path', cfg.downloadPath);
            updateHint('hint-url', cfg.searchUrl);
        }

        function updateHint(id, val) {
            const el = document.getElementById(id);
            if(val) { el.innerText = val; el.classList.remove('empty'); }
            else { el.innerText = "æœªè®¾ç½®"; el.classList.add('empty'); }
        }

        function openSettings() { updateSettingsUI(globalConfig); document.getElementById('modal-settings').classList.add('show'); }
        function openHelp() { document.getElementById('modal-help').classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        function saveSettings() {
            const config = {
                senderEmail: document.getElementById('cfg-sender').value.trim(),
                senderPass: document.getElementById('cfg-pass').value.trim(),
                targetKindle: document.getElementById('cfg-kindle').value.trim(),
                downloadPath: document.getElementById('cfg-path').value.trim(),
                searchUrl: document.getElementById('cfg-url').value.trim()
            };
            if(!config.senderEmail || !config.senderPass) { alert("é‚®ç®±ä¿¡æ¯ä¸èƒ½ä¸ºç©º"); return; }
            window.go.main.App.SaveSettings(config).then(res => {
                showLog(res); closeModal('modal-settings'); globalConfig = config; loadFiles();
            });
        }
        // ... (å…¶ä½™ä¸šåŠ¡é€»è¾‘å‡½æ•°ä¿æŒä¸å˜ï¼ŒsendFiles, toggleAll ç­‰) ...
        function searchBook() { const q=document.getElementById('query').value; if(q) window.go.main.App.SearchBook(q); }
        function testConn() { window.go.main.App.TestConnection().then(res => { showLog(res); alert(res); }); }
        function loadFiles() { window.go.main.App.ListBooks().then(books => { allBooks=books; renderTable(); }); }
        function renderTable() {
            const tbody = document.getElementById('table-body'); tbody.innerHTML="";
            const filtered = allBooks.filter(b => currentFilter==='ALL'||b.type===currentFilter);
            if(filtered.length===0) { document.getElementById('empty-state').style.display='block'; return; }
            document.getElementById('empty-state').style.display='none';
            filtered.forEach(b => {
                const tr = document.createElement('tr');
                tr.onclick = (e) => { if(e.target.type!=='checkbox') { const cb=tr.querySelector('.cb'); cb.checked=!cb.checked; updateSel(); }};
                tr.innerHTML=`<td style="text-align:center"><input type="checkbox" class="cb" data-path="${b.path}" onchange="updateSel()"></td>
                    <td style="font-weight:500"><span class="type-badge type-${b.type}">${b.type}</span>${b.name}</td>
                    <td style="color:#64748b;font-size:13px">${b.size}</td><td style="color:#64748b;font-size:13px">${b.modTime}</td>`;
                tbody.appendChild(tr);
            });
        }
        function applyFilter(t, el) { currentFilter=t; document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); renderTable(); }
        function toggleAll(src) { document.querySelectorAll('.cb').forEach(c=>c.checked=src.checked); updateSel(); }
        function updateSel() { const n=document.querySelectorAll('.cb:checked').length; const btn=document.getElementById('sendBtn'); btn.innerText=`ğŸš€ å‘é€é€‰ä¸­ä¹¦ç± (${n})`; btn.disabled=n===0; }
        function sendFiles() {
            const paths=Array.from(document.querySelectorAll('.cb:checked')).map(c=>c.getAttribute('data-path'));
            const btn=document.getElementById('sendBtn'); btn.disabled=true; btn.innerText="â³ å‘é€ä¸­...";
            window.go.main.App.SendSelectedBooks(paths).then(res=>{ showLog(res); btn.disabled=false; btn.innerText="ğŸš€ å‘é€é€‰ä¸­ä¹¦ç± (0)"; document.querySelectorAll('.cb').forEach(c=>c.checked=false); });
        }
        function showLog(html) { const el=document.getElementById('log-overlay'); el.style.display='block'; el.innerHTML=html; setTimeout(()=>el.style.display='none', 4000); }
    </script>
</body>
</html>