<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>KindleSend</title>
    <link rel="stylesheet" href="/src/style.css">
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="search-wrapper">
                <span class="search-icon">🔍</span>
                <input type="text" id="query" class="search-input" placeholder="输入书名 (自动调用 fuckfbi.ru)...">
            </div>
            <button class="btn-primary" onclick="searchBook()">搜索</button>
            <button class="btn-outline" onclick="testConn()">连通测试</button>
            <button class="btn-outline btn-icon" onclick="openSettings()">⚙️ 设置</button>
            <button class="btn-outline btn-icon" onclick="openHelp()">❓ 帮助</button>
        </div>
        <div class="filter-bar">
            <div class="filter-chip active" onclick="applyFilter('ALL', this)">全部</div>
            <div class="filter-chip" onclick="applyFilter('EPUB', this)">EPUB</div>
            <div class="filter-chip" onclick="applyFilter('PDF', this)">PDF</div>
            <div class="filter-chip" onclick="applyFilter('MOBI', this)">MOBI</div>
            <div class="filter-chip" onclick="applyFilter('AZW3', this)">AZW3</div>
        </div>
    </div>

    <div class="content">
        <div class="file-card">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width:40px;text-align:center"><input type="checkbox" id="selectAllCb" onchange="toggleAll(this)"></th>
                            <th data-sort="name" onclick="sortBooks('name')">文件名 <span class="sort-icon">↕</span></th>
                            <th style="width:100px" data-sort="size" onclick="sortBooks('size')">大小 <span class="sort-icon">↕</span></th>
                            <th style="width:160px" data-sort="modTime" class="sorted" onclick="sortBooks('modTime')">修改时间 <span class="sort-icon">↓</span></th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            <div id="empty-state" style="padding:60px;text-align:center;display:none;color:#64748b">
                <div style="font-size:40px;margin-bottom:10px">📂</div>
                <p>这里空空如也，请先去"设置"检查下载路径</p>
                <button class="btn-outline" onclick="loadFiles()" style="margin:15px auto">刷新列表</button>
            </div>
        </div>
    </div>
    <div id="log-overlay" class="log-overlay"></div>

    <!-- Progress Container -->
    <div id="progress-container" class="progress-container" style="text-align:center">
        <div class="progress-ring">
            <svg width="120" height="120">
               <circle class="bg" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
               <circle class="progress" stroke-width="8" fill="transparent" r="52" cx="60" cy="60" style="stroke-dasharray: 326.726; stroke-dashoffset: 326.726;"/>
            </svg>
            <div class="progress-text" id="progress-pct-text">0%</div>
        </div>
        <div class="progress-header" style="justify-content:center; margin-bottom:5px;">
            <span id="progress-title" style="font-size:16px; font-weight:bold;">准备发送...</span>
        </div>
        <div style="color:#94a3b8; font-size:13px; margin-bottom:15px;" id="progress-count">0 / 0</div>

        <div class="progress-bar-bg" style="display:none">
            <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%"></div>
        </div>
        <div id="progress-logs" class="progress-logs" style="text-align:left"></div>
    </div>

    <div class="footer">
        <div class="status-bar">
            <button class="btn-outline" onclick="loadFiles()">🔄 刷新</button>
            <span id="status-text" style="margin-left:15px;font-size:14px;color:#64748b">就绪</span>
        </div>
        <button class="btn-send" id="sendBtn" onclick="sendFiles()" disabled>🚀 发送选中书籍 (0)</button>
    </div>

    <div id="modal-settings" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><div class="modal-title">⚙️ 软件配置</div><div class="close-btn" onclick="closeModal('modal-settings')">&times;</div></div>

            <div class="tabs">
                <div class="tab-item active" onclick="switchTab('tab-account', this)">邮箱配置</div>
                <div class="tab-item" onclick="switchTab('tab-paths', this)">本地设置</div>
            </div>

            <div id="tab-account" class="tab-content active tab-scrollable">
                <div class="settings-section">
                    <div class="section-title">发送账户</div>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label class="form-label">发件人邮箱</label>
                            <input type="text" id="cfg-sender" class="form-input" placeholder="例如: 123@qq.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">邮箱授权码</label>
                            <input type="password" id="cfg-pass" class="form-input" placeholder="16位授权码，非登录密码">
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="section-title">接收设置</div>
                    <div class="settings-grid">
                        <div class="form-group full-width">
                            <label class="form-label">Kindle 接收邮箱</label>
                            <input type="text" id="cfg-kindle" class="form-input" placeholder="例如: name@kindle.com">
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="section-title">SMTP 服务器 <span class="section-hint">（通常无需修改）</span></div>
                    <div class="settings-grid">
                        <div class="form-group full-width">
                            <label class="form-label">服务器地址</label>
                            <input type="text" id="cfg-smtp-server" class="form-input" placeholder="默认: smtp.qq.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">发送端口 (SSL)</label>
                            <input type="number" id="cfg-smtp-port" class="form-input" placeholder="默认: 465">
                        </div>
                        <div class="form-group">
                            <label class="form-label">测试端口</label>
                            <input type="number" id="cfg-smtp-test-port" class="form-input" placeholder="默认: 587">
                        </div>
                    </div>
                </div>
                <div id="account-warnings" class="config-warnings"></div>
            </div>

            <div id="tab-paths" class="tab-content">
                <div class="settings-section">
                    <div class="section-title">文件路径</div>
                    <div class="settings-grid">
                        <div class="form-group full-width">
                            <label class="form-label">本地书籍下载路径</label>
                            <input type="text" id="cfg-path" class="form-input" placeholder="例如 D:\Downloads">
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="section-title">搜索设置</div>
                    <div class="settings-grid">
                        <div class="form-group full-width">
                            <label class="form-label">搜索网址模板</label>
                            <input type="text" id="cfg-url" class="form-input" placeholder="使用 %s 代表搜索关键词">
                            <div class="field-hint">例如: https://example.com/search?q=%s</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-outline" onclick="testConnInline()" id="testConnBtn">🔗 测试连接</button>
                <button class="btn-primary" onclick="saveSettings()" style="padding:12px 30px;">💾 保存配置</button>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><div class="modal-title">📖 使用指南与注意事项</div><div class="close-btn" onclick="closeModal('modal-help')">&times;</div></div>
            <div class="help-content">
                <div class="help-card">
                    <div class="help-head">🔥 核心功能</div>
                    <ul class="help-list">
                        <li><b>自动清洗</b>：发送时自动删除文件名中的 "(Z-Library)" 等广告后缀。</li>
                        <li><b>防乱码</b>：内置编码转换，解决 Kindle 收到中文书名乱码的问题。</li>
                        <li><b>一键传输</b>：支持批量选择，一键通过邮件推送到 Kindle。</li>
                    </ul>
                </div>
                <div class="help-card">
                    <div class="help-head">⚙️ 配置三步走 (首次必看)</div>
                    <ul class="help-list">
                        <li>1. <b>QQ 邮箱</b>：开启 POP3/SMTP 服务，获取 16 位授权码 (设置->账户)。</li>
                        <li>2. <b>亚马逊</b>：将你的 QQ 邮箱加入“已认可的发件人列表” (个人文档设置)。</li>
                        <li>3. <b>本软件</b>：在设置中填入以上信息，并指定下载路径。</li>
                    </ul>
                </div>
                <div class="help-card" style="margin-bottom:0; background:#fffbeb; border-color:#fde68a;">
                    <div class="help-head" style="color:#b45309;">⚠️ 常见问题</div>
                    <ul class="help-list" style="color:#b45309;">
                        <li>• 若提示 "Authentication failed"，请检查授权码是否过期或填错。</li>
                        <li>• 若 Kindle 收不到，请检查是否已在亚马逊后台添加白名单。</li>
                        <li>• 配置文件现在保存在系统 AppData 目录，升级软件配置不丢失。</li>
                    </ul>
                </div>
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-primary" onclick="closeModal('modal-help')">我已了解</button>
            </div>
        </div>
    </div>

    <script type="module" src="/src/main.js"></script>
</body>
</html>
